<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.isliqian.sys.mapper.SysOfficeMapper">

    <sql id="officeColumns">
		a.id,
		a.parent_id AS "parent.id",
		a.parent_ids,
		a.area_id AS "area.id",
		a.code,
		a.name,
		a.sort,
		a.type,
		a.grade,
		a.master,
		a.phone,
		a.address,
		a.remarks,
		a.create_date AS "createDate",
		a.update_date AS "updateDate",
		a.del_flag,
		a.useable AS useable,
		p.name AS "parent.name",
		p.code AS "parent.code",
		ar.name AS "area.name",
		ar.parent_ids AS "area.parentIds"
	</sql>

    <sql id="officeJoins">
		LEFT JOIN sys_office p ON p.id = a.parent_id
		LEFT JOIN sys_area ar ON ar.id = a.area_id
    </sql>

    <select id="get" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.id = #{id}
    </select>

    <select id="findList" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="code != null and code != ''">
                and a.code = #{code}
            </if>
            <if test="type != null and type != ''">
                and a.type = #{type}
            </if>
        </where>
        <!-- 数据范围过滤 -->
        ${sqlMap.dsf}
        ORDER BY a.code
    </select>

    <select id="getChildren" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="id != null and id != ''">
                and a.parent_id = #{id}
            </if>
        </where>
        ORDER BY a.code
    </select>

    <select id="findAllList" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.del_flag = #{DEL_FLAG_NORMAL}
        ORDER BY a.code
    </select>

    <select id="findIsAutoList" resultType="io.github.isliqian.sys.bean.SysOffice" useCache="true">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.del_flag = #{DEL_FLAG_NORMAL}
        AND a.isauto_fee = #{isautoFee}
    </select>

    <select id="findByParentIdsLike" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            <if test="delFlag != null and delFlag != ''">
                AND a.del_flag = #{delFlag}
            </if>
            <if test="parentIds != null and parentIds != ''">
                AND a.parent_ids LIKE #{parentIds}
            </if>
        </where>
        ORDER BY a.code
    </select>

    <insert id="insert">
		INSERT INTO sys_office(
			id,
			parent_id,
			parent_ids,
			area_id,
			code,
			name,
			sort,
			type,
			grade,
			address,
			create_date,
			update_date,
			remarks,
			del_flag,
			useable
		) VALUES (
			#{id},
			#{parent.id},
			#{parentIds},
			#{area.id},
			#{code},
			#{name},
			#{sort},
			#{type},
			#{grade},
			#{address},
			#{createDate},
			#{updateDate},
			#{remarks},
			#{delFlag},
			#{useable}
		)
	</insert>

    <update id="update">
		UPDATE sys_office SET
			parent_id = #{parent.id},
			parent_ids = #{parentIds},
			area_id = #{area.id},
			code = #{code},
			name = #{name},
			type = #{type},
			grade = #{grade},
			address = #{address},
			update_date = #{updateDate},
			remarks = #{remarks},
			useable=#{useable}
		WHERE id = #{id}
	</update>

    <update id="updateParentIds">
		UPDATE sys_office SET
			parent_id = #{parent.id},
			parent_ids = #{parentIds}
		WHERE id = #{id}
	</update>

    <update id="delete">
        UPDATE sys_office SET
        del_flag = #{DEL_FLAG_DELETE},
        update_date = #{updateDate}
        WHERE id = #{id} OR parent_ids LIKE
        <if test="dbName == 'oracle'">'%,'||#{id}||',%'</if>
        <if test="dbName == 'mssql'">'%,'+#{id}+',%'</if>
        <if test="dbName == 'mysql'">CONCAT('%,', #{id}, ',%')</if>
    </update>

    <!-- 批量插入 -->
    <insert id="insertList" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            INSERT INTO sys_office(
            id,
            parent_id,
            parent_ids,
            area_id,
            code,
            name,
            sort,
            type,
            grade,
            master,
            phone,
            address,
            create_date,
            update_date,
            remarks,
            del_flag,
            useable
            ) VALUES (
            #{item.id},
            #{item.parent.id},
            #{item.parentIds},
            #{item.area.id},
            #{item.code},
            #{item.name},
            #{item.sort},
            #{item.type},
            #{item.grade},
            #{item.master},
            #{item.phone},
            #{item.address},
            #{item.createDate},
            #{item.updateDate},
            #{item.remarks},
            #{item.delFlag},
            #{item.useable}
            )
        </foreach>
    </insert>

    <!-- 批量更新 -->
    <insert id="updateList" parameterType="java.util.List">
        <foreach collection="list" item="item">
            UPDATE sys_office SET
            <choose>
                <when test="item.parent != null">
                    parent_id = #{item.parent.id, jdbcType=VARCHAR},
                </when>
                <otherwise>
                    parent_id = NULL,
                </otherwise>
            </choose>
            parent_ids = #{item.parentIds, jdbcType=VARCHAR},
            <choose>
                <when test="item.area != null">
                    area_id = #{item.area.id, jdbcType=VARCHAR},
                </when>
                <otherwise>
                    area_id = NULL,
                </otherwise>
            </choose>
            code = #{item.code, jdbcType=VARCHAR},
            name = #{item.name, jdbcType=VARCHAR},
            type = #{item.type, jdbcType=CHAR},
            grade = #{item.grade, jdbcType=CHAR},
            address = #{item.address, jdbcType=VARCHAR},
            update_date = #{item.updateDate, jdbcType=TIMESTAMP},
            remarks = #{item.remarks, jdbcType=VARCHAR},
            useable = #{item.useable, jdbcType=VARCHAR},
            <choose>
                <when test="item.primaryPerson != null">
                    primary_person = #{item.primaryPerson.id, jdbcType=VARCHAR},
                </when>
                <otherwise>
                    primary_person = NULL,
                </otherwise>
            </choose>
            <choose>
                <when test="item.deputyPerson != null">
                    deputy_person = #{item.deputyPerson.id, jdbcType=VARCHAR}
                </when>
                <otherwise>
                    deputy_person = NULL
                </otherwise>
            </choose>
            WHERE id = #{item.id, jdbcType=VARCHAR};
        </foreach>
    </insert>

    <!--批量逻辑删除-->
    <update id="deleteList" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            UPDATE sys_office SET
            del_flag = #{item.DEL_FLAG_DELETE},
            update_date = #{updateDate}
            WHERE id = #{item.id}
        </foreach>
    </update>

    <!--根据起始更新时间查询-->
    <select id="findListByUpdateDate" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            <if test="startDate != null">
                a.update_date <![CDATA[>=]]> #{startDate}
            </if>
            <if test="endDate != null">
                AND a.update_date <![CDATA[<=]]> #{endDate}
            </if>
        </where>
    </select>

    <select id="findListByArea" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="area != null and area != ''">
                AND a.area_id = #{area.id}
            </if>
            <if test="type != null and type != ''">
                AND a.type = #{type}
            </if>
            <if test="name != null and name != ''">
                AND a.name LIKE concat('%',#{name},'%')
            </if>
        </where>
        <!-- 数据范围过滤 -->
        ${sqlMap.dsf}
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.code
            </otherwise>
        </choose>
    </select>

</mapper>