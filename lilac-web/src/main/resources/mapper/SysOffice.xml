<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.isliqian.sys.mapper.SysOfficeMapper">

    <sql id="officeColumns">
		a.id,
		a.parent_id AS "parent.id",
		a.parent_ids,
		a.area_id AS "area.id",
		a.code,
		a.name,
		a.sort,
		a.type,
		a.grade,
		a.address,
		a.remarks,
		a.create_by AS "createBy.id",
		a.create_date,
		a.update_by AS "updateBy.id",
		a.update_date,
		a.del_flag,
		a.useable AS useable,
		a.primary_person AS "primaryPerson.id",
		a.deputy_person AS "deputyPerson.id",
		a.developers,
		a.building_year,
		a.building_type,
		a.building_number,
		a.volume_ratio,
		a.green_ratio,
		a.email_password,
		a.email_username,
		a.aes_key,
		a.app_id,
		a.mer_id,
		a.email_popport,
		a.public_key,
		a.private_key,
		a.email_pophost,
		a.isauto_fee,
		a.email_to,
		p.name AS "parent.name",
		p.code AS "parent.code",
		ar.name AS "area.name",
		ar.parent_ids AS "area.parentIds",
		pp.name AS "primaryPerson.name",
		dp.name AS "deputyPerson.name"
	</sql>

    <sql id="officeJoins">
		LEFT JOIN sys_office p ON p.id = a.parent_id
		LEFT JOIN sys_area ar ON ar.id = a.area_id
		LEFT JOIN SYS_USER pp ON pp.id = a.primary_person
		LEFT JOIN SYS_USER dp ON dp.id = a.deputy_person
    </sql>

    <select id="get" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.id = #{id}
    </select>

    <select id="findList" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="code != null and code != ''">
                and a.code = #{code}
            </if>
            <if test="type != null and type != ''">
                and a.type = #{type}
            </if>
        </where>
        <!-- 数据范围过滤 -->
        ${sqlMap.dsf}
        ORDER BY a.code
    </select>

    <select id="getChildren" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="id != null and id != ''">
                and a.parent_id = #{id}
            </if>
        </where>
        ORDER BY a.code
    </select>

    <select id="findAllList" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.del_flag = #{DEL_FLAG_NORMAL}
        ORDER BY a.code
    </select>

    <select id="findIsAutoList" resultType="io.github.isliqian.sys.bean.SysOffice" useCache="true">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.del_flag = #{DEL_FLAG_NORMAL}
        AND a.isauto_fee = #{isautoFee}
    </select>

    <select id="findByParentIdsLike" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            <if test="delFlag != null and delFlag != ''">
                AND a.del_flag = #{delFlag}
            </if>
            <if test="parentIds != null and parentIds != ''">
                AND a.parent_ids LIKE #{parentIds}
            </if>
        </where>
        ORDER BY a.code
    </select>

    <insert id="insert">
		INSERT INTO sys_office(
			id,
			parent_id,
			parent_ids,
			area_id,
			code,
			name,
			sort,
			type,
			grade,
			address,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag,
			useable,
			primary_person,
			deputy_person,
			developers,
			building_year,
			building_type,
			building_number,
			volume_ratio,
			green_ratio,
			email_password,
			email_username,
			aes_key,
			app_id,
			mer_id,
			email_popport,
			public_key,
			private_key,
			email_pophost,
			isauto_fee,
			email_to
		) VALUES (
			#{id},
			#{parent.id},
			#{parentIds},
			#{area.id},
			#{code},
			#{name},
			#{sort},
			#{type},
			#{grade},
			#{address},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag},
			#{useable},
			#{primaryPerson.id},
			#{deputyPerson.id},
			#{developers},
			#{buildingYear},
			#{buildingType},
			#{buildingNumber},
			#{volumeRatio},
			#{greenRatio},
			#{emailPassword},
			#{emailUsername},
			#{aesKey},
			#{appId},
			#{merId},
			#{emailPopport},
			#{publicKey},
			#{privateKey},
			#{emailPophost},
			#{isautoFee},
			#{emailTo}
		)
	</insert>

    <update id="update">
		UPDATE sys_office SET
			parent_id = #{parent.id},
			parent_ids = #{parentIds},
			area_id = #{area.id},
			code = #{code},
			name = #{name},
			type = #{type},
			grade = #{grade},
			address = #{address},
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			remarks = #{remarks},
			useable=#{useable},
			primary_person=#{primaryPerson.id},
			deputy_person=#{deputyPerson.id},
			developers = #{developers},
			building_year = #{buildingYear},
			building_type = #{buildingType},
			building_number = #{buildingNumber},
			volume_ratio = #{volumeRatio},
			green_ratio = #{greenRatio},
			email_password = #{emailPassword},
			email_username = #{emailUsername},
			aes_key = #{aesKey},
			app_id = #{appId},
			mer_id = #{merId},
			email_popport = #{emailPopport},
			public_key = #{publicKey},
			private_key = #{privateKey},
			email_pophost = #{emailPophost},
			isauto_fee = #{isautoFee},
			email_to = #{emailTo}
		WHERE id = #{id}
	</update>

    <update id="updateParentIds">
		UPDATE sys_office SET
			parent_id = #{parent.id},
			parent_ids = #{parentIds}
		WHERE id = #{id}
	</update>

    <update id="delete">
        UPDATE sys_office SET
        del_flag = #{DEL_FLAG_DELETE},
        update_date =
        <if test="dbName == 'oracle'">sysdate</if>
        <if test="dbName == 'mssql'">GETDATE()</if>
        <if test="dbName == 'mysql'">NOW()</if>
        WHERE id = #{id} OR parent_ids LIKE
        <if test="dbName == 'oracle'">'%,'||#{id}||',%'</if>
        <if test="dbName == 'mssql'">'%,'+#{id}+',%'</if>
        <if test="dbName == 'mysql'">CONCAT('%,', #{id}, ',%')</if>
    </update>

    <!-- 批量插入 -->
    <insert id="insertList" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            INSERT INTO sys_office(
            id,
            parent_id,
            parent_ids,
            area_id,
            code,
            name,
            sort,
            type,
            grade,
            address,
            create_by,
            create_date,
            update_by,
            update_date,
            remarks,
            del_flag,
            useable,
            primary_person,
            deputy_person,
            developers,
            building_year,
            building_type,
            building_number,
            volume_ratio,
            green_ratio,
            email_password,
            email_username,
            aes_key,
            app_id,
            mer_id,
            email_popport,
            public_key,
            private_key,
            email_pophost,
            isauto_fee,
            email_to
            ) VALUES (
            #{item.id},
            #{item.parent.id},
            #{item.parentIds},
            #{item.area.id},
            #{item.code},
            #{item.name},
            #{item.sort},
            #{item.type},
            #{item.grade},
            #{item.address},
            #{item.createBy.id},
            #{item.createDate},
            #{item.updateBy.id},
            #{item.updateDate},
            #{item.remarks},
            #{item.delFlag},
            #{item.useable},
            #{item.primaryPerson.id},
            #{item.deputyPerson.id},
            #{item.developers},
            #{item.buildingYear},
            #{item.buildingType},
            #{item.buildingNumber},
            #{item.volumeRatio},
            #{item.greenRatio},
            #{item.emailPassword},
            #{item.emailUsername},
            #{item.aesKey},
            #{item.appId},
            #{item.merId},
            #{item.emailPopport},
            #{item.publicKey},
            #{item.privateKey},
            #{item.emailPophost},
            #{item.isautoFee},
            #{item.emailTo}
            )
        </foreach>
    </insert>

    <!-- 批量更新 -->
    <insert id="updateList" parameterType="java.util.List">
        <foreach collection="list" item="item">
            UPDATE sys_office SET
            <choose>
                <when test="item.parent != null">
                    parent_id = #{item.parent.id, jdbcType=VARCHAR},
                </when>
                <otherwise>
                    parent_id = NULL,
                </otherwise>
            </choose>
            parent_ids = #{item.parentIds, jdbcType=VARCHAR},
            <choose>
                <when test="item.area != null">
                    area_id = #{item.area.id, jdbcType=VARCHAR},
                </when>
                <otherwise>
                    area_id = NULL,
                </otherwise>
            </choose>
            code = #{item.code, jdbcType=VARCHAR},
            name = #{item.name, jdbcType=VARCHAR},
            type = #{item.type, jdbcType=CHAR},
            grade = #{item.grade, jdbcType=CHAR},
            address = #{item.address, jdbcType=VARCHAR},
            update_by = #{item.updateBy.id, jdbcType=VARCHAR},
            update_date = #{item.updateDate, jdbcType=TIMESTAMP},
            remarks = #{item.remarks, jdbcType=VARCHAR},
            useable = #{item.useable, jdbcType=VARCHAR},
            <choose>
                <when test="item.primaryPerson != null">
                    primary_person = #{item.primaryPerson.id, jdbcType=VARCHAR},
                </when>
                <otherwise>
                    primary_person = NULL,
                </otherwise>
            </choose>
            <choose>
                <when test="item.deputyPerson != null">
                    deputy_person = #{item.deputyPerson.id, jdbcType=VARCHAR}
                </when>
                <otherwise>
                    deputy_person = NULL
                </otherwise>
            </choose>
            WHERE id = #{item.id, jdbcType=VARCHAR};
        </foreach>
    </insert>

    <!--批量逻辑删除-->
    <update id="deleteList" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            UPDATE sys_office SET
            del_flag = #{item.DEL_FLAG_DELETE},
            update_date =
            <if test="dbName == 'oracle'">sysdate</if>
            <if test="dbName == 'mssql'">GETDATE()</if>
            <if test="dbName == 'mysql'">NOW()</if>
            WHERE id = #{item.id}
        </foreach>
    </update>

    <!--根据起始更新时间查询-->
    <select id="findListByUpdateDate" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            <if test="startDate != null">
                a.update_date <![CDATA[>=]]> #{startDate}
            </if>
            <if test="endDate != null">
                AND a.update_date <![CDATA[<=]]> #{endDate}
            </if>
        </where>
    </select>

    <select id="findListByArea" resultType="io.github.isliqian.sys.bean.SysOffice">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="area != null and area != ''">
                AND a.area_id = #{area.id}
            </if>
            <if test="type != null and type != ''">
                AND a.type = #{type}
            </if>
            <if test="name != null and name != ''">
                AND a.name LIKE concat('%',#{name},'%')
            </if>
        </where>
        <!-- 数据范围过滤 -->
        ${sqlMap.dsf}
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.code
            </otherwise>
        </choose>
    </select>

</mapper>